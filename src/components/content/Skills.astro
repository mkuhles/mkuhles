---
import SkillElement from "./SkillElement.astro";
import {skills} from "../../data/mkuhles.json";
import { COLOR_SCALE } from "../../scripts/collorCalculations";

const {lang} = Astro.props;
const colorScaleString = COLOR_SCALE.join();

const circleDiameter =           "85vmin";
const circleElementDiameter =    "13vmin";
const circleElementMaxDiameter = "400px";
const circleElementFontSize =    "2vmin";
const circleElementPadding =     "1vmin";
const scaleWidth =               "1.5vmin";
---
<div class="flex-center">
  <div id="skillLevelScale" class="scale">
    <div class="scale__top">{"Grundlagen"}</div>
    <div class="scale__bottom">{"Expertenwissen"}</div>
  </div>
  <div id="circle-container" class="circle-container">
    <div class="center-element circle">{lang == 'de' ? "Ich kann" : "my skills"}</div>
    {skills.map( (skill) => <SkillElement skill={skill} /> )}
  </div>
</div>

<style define:vars={{colorScaleString, circleDiameter, circleElementDiameter, circleElementMaxDiameter, circleElementFontSize, circleElementPadding, scaleWidth}}>
/* Legende als Verlauf */
.scale {
  position: relative;
  width: var(--scaleWidth);
  height: var(--circleDiameter);
  background: linear-gradient(to bottom,
    var(--colorScaleString));
}
.scale__top {
  position: absolute;
  top: 0;
  left: calc(2 * var(--scaleWidth));
}
.scale__bottom {
  position: absolute;
  bottom: 0;
  left: calc(2 * var(--scaleWidth));
}

.flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: calc(2 * var(--scaleWidth));
}

 #circle-container {
  position: relative;
  width: var(--circleDiameter);
  height: var(--circleDiameter);
  
  .circle {
    position: absolute;
    width: var(--circleElementDiameter);
    height: var(--circleElementDiameter);
    max-width: var(--circleElementMaxDiameter);
    max-height: var(--circleElementMaxDiameter);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    text-align: center;
    font-size: var(--circleElementFontSize);
    padding: var(--circleElementPadding);
    box-sizing: border-box;
  }

  .center-element {
    position: absolute;
    width: var(--circleElementDiameter);
    height: var(--circleElementDiameter);
    max-width: var(--circleElementMaxDiameter);
    max-height: var(--circleElementMaxDiameter);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    z-index: 100;
    text-align: center;
  }

  .circle-element {
    font-weight: bold;
    opacity: 0;
  }
}
</style>

<script>
  import useCircleAnimation from "../../scripts/useCircleAnimation";
  
  const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
  document.documentElement.classList.toggle('reduced-motion', mq.matches);
  mq.addEventListener?.('change', e =>
    document.documentElement.classList.toggle('reduced-motion', e.matches)
  );
  mq.addListener?.(e =>
    document.documentElement.classList.toggle('reduced-motion', e.matches)
  ); // Fallback

const container = document.getElementById('circle-container');
let stopAnimation: (() => void) | undefined | null = null;

function start() {
    if (!stopAnimation) {
      stopAnimation = useCircleAnimation( mq.matches); // startet animation und gibt cleanup zurÃ¼ck
    }
}
  function stop() {
    if (stopAnimation) {
      stopAnimation();
      stopAnimation = null;
    }
  }

const onScroll = () => {
    if(!container) return;
    const rect = container.getBoundingClientRect();
    const inView = rect.top < window.innerHeight * 0.85 && rect.bottom > 0;
    if (inView) start(); else stop();
};
  window.addEventListener('scroll', onScroll, { passive: true });
  onScroll();
  window.addEventListener('beforeunload', () => { window.removeEventListener('scroll', onScroll); stop(); });
</script>